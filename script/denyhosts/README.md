# 网络安全构建

文档版本号:v1.0.1

# 目录
- [Filecoin单点业务数据安全分类](#Filecoin单点业务数据安全分类)
- [路由器或防火](#路由器或防火墙)
- [ssh代理机或vpn机制](#ssh代理机或vpn机制)
- [保垒机](#保垒机)
- [专用管理机](#专用管理机)
- [矿工密钥管理机(若有)](#矿工密钥管理机(若有))
- [链设备](#链设备)
- [矿工设备](#矿工设备)
- [存储设备](#存储设备)
- [计算设备](#计算设备)
- [附录](#附录)
  - [变更记录](变更记录)

# Filecoin单点业务数据安全分类
管理员安全权限管理
```
TODO:
```

数据传输安全
```
启用加密或数据校验等功能，机密数据应避免中间监听、重要数据应确保发送与接收是一致的。
```

数据存储安全
```
1，能加密存放的数据应加密存放
2, 机密数据停用时应能被可靠擦除。
```

硬件安全访问
```
硬件若没有视频监控覆盖到的，应上硬件锁，锁住设备
```

系统关键日志保存
```
系统关键日志应能集中保存，若不能，单机环境下尽可能保存1年以上。
```

管理权限进入通道结构图
```
            路由器
               |
            ssh代理
           /       \
     公共保垒机   专用管理机
    /     \           |
 存储节点 计算节点 专用设备(链/矿工)

ssh代理 只接ssh的入口请求，及对内网公共保垒机、专用管理机的ssh请求。
公共保垒机，离线部署，sshd只接受来自ssh代理机ip。
专用管理机，离线部署，sshd只接受来自ssh代理机ip。
存储节点，离线部署，sshd只接受来自保垒机与部署机的ip
计算节点，离线部署，sshd只接受来自保垒机与部署机的ip
专用设备，需要外网，sshd只接受来自ssh代理机ip。
```

# 路由器或防火墙
路由器是隔绝内网与外网的总体入口(物理层面除外, 机房物理管理视为内部内网访问)，需要以下功能进行网络支持：
```
1，高性能的网络转发要求(视外网数据传能力而定)
2，封闭外网对内网请求的能力，按需开通对内网的访问，即需要开通端口映射后方可访问内网。(
   路由器本身仍有操作系统层或硬件层的漏洞需要进一步讨论)
3, 封闭内网对外网请求的能力，按需开通对外网的访问，即需要开通路由表白名单后方可访问外网。(
   若能越过的漏洞需要进一步讨论)
4, 因本网络无法完绝隔绝外网，发现路由器本身的漏洞时应及时讨论处理，主动未造成影响时为最佳
5，路由器必须使用内网才能进行权限管理(当内部代理机器损坏时，外部人员应在机房物理局域网登录，
   或等待内部代理机恢复后再启用).
6, 若有条件，应启用相关防火墙技术，记录所有请求的来源与去向网络日志，以备审计与校验合法与非法的网络请求。
```

# ssh代理机或vpn机制
因我对VPN的应用不熟，无法完成相关管理机制，因此启用ssh代理及其配套应用作为机房入口的管控工作。

在未能建立成熟的内网连接机制之前，此代理机将完全采用开源的软件技术进行部署与代理内网管理人员的进入，

业务应用入口则应走路由器的外网访问策略。

本台机器只能启用一个ssh对外端口程序。

非代理至公共保垒机或专用管理机的访问不应被授权(其他机器应通过防火墙进行拒绝服务)。

TODO: 自研或寻找部署开源的ssh登录服务功能，需电脑证书与不同设备上的验证码授权方可进入，必要时应推广至其他核心设备上。

要求如下：
```
1，本台机器禁用root权限，仅能完全可靠的人方能进行root权限的软件安装与更新操作。
2，所有账户接入本台机器应为非root权限，并且通过ssh证书方式登录后方通过su -进入root管理
   TODO: 证书定期更新与更新方式
3, 开启系统登录日志时间不低于1年(实际需要评估相关文件大小增量,/etc/logrotate.conf)
4, 机房内部web资料通过个人ssh代理再访问机房内部(配置chrome socket5本地ssh代理)。
5, 定期交叉人员巡检系统日志及安全补丁、及更新个人人员登录证书，并通过aes256加密后发送邮件给个人，
   解密密码通过另一通讯方式(信封?), 个人接收到应妥善保存密钥(限制外网ip?)
6, 此入口机为主备两台，主入口损坏时，将启用备用入口, 主备应1月切换一次或者部分用户使用主入口，部分用户同时。
```

具体操作：
```
# 1, 下载配置脚本模板
git clone https://git.grandhelmsman.com/yunwei/iptables.git

# 2, 生成接入服务器的证书
./auth-on.sh helmsman
# 3, 首次生成证书后要复制到本地
scp -p 5222 helmsman@xx.xx.xx.xx:/home/helmsman/os_ubuntu18/helmsman.tar.gz . # 此为ssh私钥加密证书，密码在helmsman.pwd中, 请另行保存，将在使用证书时用到
# 4, 验证登录，非常重要, 在本地机器上执行
tar -xzf helmsman.tar.gz
ssh -i helsman.key -p 5222 helsmman@xx.xx.xx.xx
# 本地输入helmsman.pwd中的密码完成证书解密后可连接上服务器，验证结束


# 5, 配置iptables-fix.sh的白名单连接机器, 内网只连接保垒机、专用机
## for output
#sudo iptables -I OUTPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
#sudo iptables -I OUTPUT -d 10.1.30.249 -p all -j ACCEPT -m comment --comment "can connect to jumpserver"
#sudo iptables -I OUTPUT -d 10.1.1.33 -p all -j ACCEPT -m comment --comment "can connect to dedicated node"
#sudo iptables -I OUTPUT -d 10.40.0.1 -p all -j ACCEPT -m comment --comment "can connect to dedicated node"
#sudo iptables -I OUTPUT -d 10.40.22.23 -p all -j ACCEPT -m comment --comment "can connect to dedicated node"

# 5, 生效ssh代理机的配置
# 此脚本将安装系统补丁，安装完成可能需要重启服务器
# 此脚本将用户ssh暴力连接拦截软件(denyhosts)，尝试连接5次不成功连接来源ip将被封禁，日志在/var/log/auth.log中
# 此脚本将自动优化ssh登录配置，将禁用root远程登录、远程密码登录，因此必须启用非root用户，并提前下载好证书, 并确保。
# 此脚本将自动优化系统日志文件存为53周，如有条件，可将此日志存储到日志服务器当中。
# 此脚本将启用iptables，只允许外网连接22端口，只允许该台机器连接内网指定ip，不能上外网，root管理员可对此进行调整，但不建议调整。
./fix-proxy.sh

# 6，重启机器，进行验证测试
sudo netstat -anp|grep "LISTEN" # 将只有22端口在提供网络服务
ping baidu.com # 无法连接外网
ping 网关 # 无法ping通连接网关或者其他非白名单机器
ssh -p 5222 helmsman@xx.xx.xx.xx # 提示只能证书登录

# 7，分配登录用户
./create-user.sh [username] # 将创建出一个普通用户，普通用户无法访问或修改本系统的系统信息
./auth-on [username] # 生成普通用户的登录证书，该用户之前若已有过证书，将自动失效；通过ssh下$username.tar.gz到本地，邮件发送证书给相关用户；使用另一种通讯软件发送$username.pwd中的证书密码给到用户
./auth-off [username] # 停用普通用户，停用后用户证书将失效，但用户数据将仍保留备查。

# 8, 普通用户登录本系统，可再次ssh到相关白名单机器上

# 9，管理员巡检工作, 每周应进行一次, 必要时另行制定
sudo netstat -anp|grep "LISTEN" # 核查网络是否启动了非法网络程序
sudo netstat -anp|grep "EST" # 核查是否有不明的网络连接
top # 查cpu是否有异常运作
sudo iptables -L -n --line-num # 查iptables是否在正常工作
mkdir -p log && sudo cp /var/log/auth* ./log # 核查登录信息是否有异常ip登录行为
# 病毒查杀，若没有，应手工ps aux核对相关进程序, 手工核对关系系统程序
ls -alt /usr/bin|grep "ssh"
ls -alt /usr/sbin|grep "ssh"
# TODO: 定期过期用户的证书，以便强制普通用户的证书接入，至少3个月应更新一次。

# 10，系统损坏处理
# 本系统当前仅支持少量用户使用，若是大量用户，应进一步开发扩展
# 本系统设计损坏时，可直接重装处理，重装后重新分配证书，原证书在新系统上直接失效。

```

# 保垒机
保垒机将用于批量管理大规模的计算机节点，及为共公人员提供接入服务，并提供审计功能。

部署方式为局域网离线部署与使用, 可安装杀毒软件(尽量确保可信或是自研，如果不可信，宁可不装, 若被攻破后，将可能绕过安全设置)。

若有条件，应自研保垒机管理软件进行设备安全管理, 确保任一代码是干净的。

要求如下：
```
1, 因保垒机含非开源软件以及不是简单能可控的软件集群，需确保与外网隔离，升级只能通过离线方式进行安装。
2, 保垒机上使用只能通过ssh代理机代理为内网后方可使用, 以确保外网的隔离机制是起效的，
   因ssh代理安全由ssh连接通道进行关键性确保, 维护人员须确保ssh代理机器是绝对可靠的。
3, 严格保垒机本身帐户权限范围，帐户开通方式为离线开通方式。
4, 保垒机本身账号的使用启用密码与不同设备上的验证码进行登录,
   验证码不可直接接入外网使用, 应通过中转至内网中的上公网机器后再出网使用。
5, 保垒机因具有公共使用性质，应进一步审核相关源码或自研相关代码，以确保漏洞可提前预知或隐藏外部已知漏洞。
```

# 专用管理机
若未能审核与证明保垒机的核心部件是安全可控的, 应建立专用管理设备与链节点、矿工节点等专用设备的交互以避开保垒机的交集。

在进入ssh专用代理机通道后再进一步接入到专用管理再进一步操作核心数据。

部署方式为局域网离线部署使用，应限定只能相关ip访问，非授权ip不能访问。

安装保护软件保护关键软件不可被修改(尽量确保可信或是自研，如果不可信，宁可不装)。

若有条件，应自研sshd接入到自有生产系统中。

# 矿工密钥管理机(若有)
当前未部署有此类型设备，若有：

部署方式为局域网离线部署使用，应限定只能相关ip访问，非授权ip不能访问。

若有自研的sshd登录软件，应部署自研的sshd。

若有可信保护软件，应安装可信保护软件。

# 链设备
当前该组节点存放了生产的密钥信息。

若有自研的sshd登录软件，应部署自研的sshd。

应限定只能相关ip访问，非授权ip不能访问。

若有可信保护软件，应安装可信保护软件。

要求如下：
```
1, 只能开放指定的业务端口上网或入网
2, 服务端口服务需要授权才能访问。
3，数据间传输须是加密(ssl)的
4, 操作系统登录权限只能来自可信设备，如：专用管理机、miner机
```

# 矿工设备
当前该组节点存放有机密信息。

若有自研的sshd登录软件，应部署自研的sshd。

应限定只能相关ip访问，非授权ip不能访问。

若有可信保护软件，应安装可信保护软件。

要求如下：
```
1, 只能开放指定的业务端口上网或入网
2, 服务端口服务需要授权才能访问。
3，数据间传输须是加密(ssl)的
4, 操作系统登录权限只能来自可信设备，如：专用管理机、miner机
```

# 存储设备
当前该组节点存放在重要数据。

若有自研的sshd登录软件，应部署自研的sshd。

若有可信保护软件，应安装可信保护软件。

部署方式为局域网离线部署与使用。

要求：
```
1, 数据的变更必须是经过授权的。
2, 数据的删除必须是授权的并安全的擦除。
```

# 计算设备
当前该组节点未存放在重要数据。

若有自研的sshd登录软件，应部署自研的sshd。

若有可信保护软件，应安装可信保护软件。

部署方式为局域网离线部署与使用。

要求：
```
1, 非root部署，以便保护系键信息不可被修改。
```

# 附录
## 变更记录
v1.0.2 2021-03-19 周树越
```
增加ssh代理管理与使用说明
```

v1.0.1 2021-03-15 周树越
```
修正语法，补充链、矿工等专用节点的部署说明。
```
v1.0.0 2021-03-15 周树越
```
初始化文档
```

